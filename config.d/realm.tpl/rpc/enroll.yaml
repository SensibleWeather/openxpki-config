# Used in some dropdowns on the UI as name for this endpoint
label: Enrollment

# A renewal request is only accpeted if the used certificate will
# expire within this period of time.
renewal_period: 000060

# Allow renewal after the certificate has already expired 
# within this grace period
# renewal_grace_period: 000005

# If the request was a replacement, optionally revoke the replaced
# certificate after a grace period
revoke_on_replace:
    reason_code: keyCompromise
    delay_revocation_time: +000014

authorized_signer:
    rule1:
        # Full DN
        subject: CN=.+:pkiclient,.*
    rule2:
        # Full DN
            subject: CN=my.scep.enroller.com:generic,.*

policy:
    # Authentication Options
    # Initial requests need ONE authentication.
    # Activate Challenge Password and/or HMAC by setting the appropriate
    # options below.

    # if set requests can be authenticated by an operator
    allow_man_authen: 1

    # if set, no authentication is required at all and hmac/challenge is
    # not evaluated even if it is set/present in the request!
    allow_anon_enroll: 0

    # Approval
    # If not autoapproved, allow opeerator to add approval by hand
    allow_man_approv: 1


    # enable if you use onbehalf certificates that are issued by CAs
    # not managed by this OpenXPKI instance. You need import the issuer
    # chains to get them validated, the certificates can then be used in
    # the authorized_signer rules
    allow_external_signer: 0

    # if the eligibility check failed the first time
    # show a button to run a recheck (Workflow goes to PENDING)
    allow_eligibility_recheck: 0
    
    # Approval points are used to set a threshold for the system to grant 
    # approval, and they help measure a request to see whether the 
    # requirement is fulfilled. If you set this to "0", no points are 
    # required and all authenticated requests are auto-approved.    
    # If the eligibilty check returned success and no approval rules are 
    # defined, you get one point for the passed check. If approval rules 
    # are given, the eligibility check is a prereq for their evaluation 
    # and there is NO point for the eligibility check itself! 
    # If you dont reach the required number of points after this step and 
    # allow_man_approv is set you can fill up the missing points by a
    # manual operator approval (one point per operator)
    approval_points: 1

    # The number of active certs with the same subject that are allowed
    # to exist at the same time, deducted by one if a renewal is seen
    # set to 0 if you dont want to check for duplicates at all
    max_active_certs: 1
 
    # If an initial enrollment is seen
    # all existing certificates with the same subject are revoked
    auto_revoke_existing_certs: 1

    # allows a "renewal" outside the renewal window, the notafter date
    # is aligned to the old certificate. Set revoke_on_replace option
    # to revoke the replaced certificate.
    # This substitutes the "replace_window" from the OpenXPKI v1 config
    allow_replace: 1

    # by default only the certificate identifier is written to the workflow
    # set to a true value to get the PEM encoded certificate in the context,
    # set to "chain" to get the issuer certificate and "fullchain" to get
    # the chain including the root certificate (key chain).
    export_certificate: chain


    # Those options are pulled by the revoke_by_entity workflow, they have no
    # effect on the enrollment workflow! You must set at least one of them or
    # remove the is_policy_loaded condition in the workflow definition

    # Allow revocation of any certificate with a certain profile
    # profile: tls_server

    # Allow revocation if the subject matches the given pattern
    # subject: "*"


profile:
  cert_profile: tls_server
  cert_subject_style: enroll

# Mapping of names to OpenXPKI profiles to be used with the
# Microsoft Certificate Template Name Ext. (1.3.6.1.4.1.311.20.2)
profile_map:
    pc-client: tls_client
    tls-server: tls_server
    tls-client: tls_client
    renewal-test: renewal_test

# HMAC based authentication
hmac: verysecret

challenge:
    value: SecretChallenge

eligible:
    initial:
       value@: connector:rpc.enroll.connector.intranet
       args: '[% context.cert_subject_parts.CN.0 %]'

    renewal:
       value: 1

    onbehalf:
       value: 1


approval_rules:
  - name: Approve only if wellformed and lowercase SAN
    class: Regex    
    param:
        san_dns: \A((?!-)[a-zA-Z0-9-]{0,62}[a-zA-Z0-9]\.)+[a-zA-Z]{2,63}\z
        cn_as_san: 1
 
connector:
    intranet:
        class: OpenXPKI::Connector::Regex
        LOCATION: \w+\.openxpki.test(:[\w]+)?\z
