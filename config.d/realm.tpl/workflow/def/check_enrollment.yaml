head:
    prefix: checkenroll
    persister: Volatile

state:
    INITIAL:
        action:
          - initialize > CHECK_FOR_PKCS10

    CHECK_FOR_PKCS10:
        autorun: 1
        action:
          - parse_pkcs7 set_pkcs10_from_payload calculate_transaction_id check_for_existing_workflow > CHECK_EXISTING_WORKFLOW ? !has_pkcs10
          - calculate_transaction_id check_for_existing_workflow > CHECK_EXISTING_WORKFLOW ? has_pkcs10

    CHECK_EXISTING_WORKFLOW:
        autorun: 1
        action:
         - global_set_error_search_has_no_matches > FAILURE ? !has_request_pending
         - global_noop > SUCCESS ? has_request_pending

    SUCCESS:
        output:
         - transaction_id
         - workflow_id

    FAILURE:
        label: I18N_OPENXPKI_UI_WORKFLOW_STATE_SEARCH_SCEP_NORESULT_LABEL
        description: I18N_OPENXPKI_UI_WORKFLOW_STATE_SEARCH_SCEP_NORESULT_DESC
        status:
            level: error
            message: I18N_OPENXPKI_UI_SEARCH_HAS_NO_MATCHES
        output:
         - transaction_id
         - error_code

action:
    initialize:
        class: OpenXPKI::Server::Workflow::Activity::Tools::SetContext
        input:
         - pkcs10
         - pkcs7
         - transaction_id

    parse_pkcs7:
        class: OpenXPKI::Server::Workflow::Activity::Tools::ParsePKCS7
        param:
            _map_pkcs7: $pkcs7
            target_key: _pkcs10

    set_pkcs10_from_payload:
        class: OpenXPKI::Server::Workflow::Activity::Tools::SetContext
        param:
            _map_pkcs10: "[% USE PKCS10; PKCS10.pem(context._pkcs10) %]"

    calculate_transaction_id:
        class: OpenXPKI::Server::Workflow::Activity::Tools::SetContext
        param:
           _map_transaction_id: >
            [% IF context.transaction_id %][% context.transaction_id %]
            [% ELSE %][% USE PKCS10 %][% PKCS10.transaction_id(context.pkcs10) %][% END %]

    check_for_existing_workflow:
        class: OpenXPKI::Server::Workflow::Activity::Tools::Datapool::GetEntry
        param:
            namespace: transaction_id
            _map_key: $transaction_id
            target_key: workflow_id

field:
    pkcs10:
        name: pkcs10
        type: server

    pkcs7:
        name: pkcs7
        type: server

condition:
    has_request_pending:
        class: Workflow::Condition::Evaluate
        param:
            test: $context->{workflow_id}

acl:
    System:
        creator: any

    RA Operator:
        creator: any
